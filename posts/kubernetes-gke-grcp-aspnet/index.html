<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Deploying an ASP.NET gRPC service on GKE with GCE Ingress" /><meta name="author" content="Ricardo Pieper" /><meta property="og:locale" content="en" /><meta name="description" content="Context" /><meta property="og:description" content="Context" /><link rel="canonical" href="https://ricardopieper.github.io//posts/kubernetes-gke-grcp-aspnet/" /><meta property="og:url" content="https://ricardopieper.github.io//posts/kubernetes-gke-grcp-aspnet/" /><meta property="og:site_name" content="Ricardo Pieper" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-12-11T03:00:00-03:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Deploying an ASP.NET gRPC service on GKE with GCE Ingress" /><meta name="twitter:site" content="@ricardopieper1" /><meta name="twitter:creator" content="@Ricardo Pieper" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Ricardo Pieper"},"dateModified":"2023-11-07T22:58:51-03:00","datePublished":"2021-12-11T03:00:00-03:00","description":"Context","headline":"Deploying an ASP.NET gRPC service on GKE with GCE Ingress","mainEntityOfPage":{"@type":"WebPage","@id":"https://ricardopieper.github.io//posts/kubernetes-gke-grcp-aspnet/"},"url":"https://ricardopieper.github.io//posts/kubernetes-gke-grcp-aspnet/"}</script><title>Deploying an ASP.NET gRPC service on GKE with GCE Ingress | Ricardo Pieper</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Ricardo Pieper"><meta name="application-name" content="Ricardo Pieper"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.updateMermaid(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/profilepic.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Ricardo Pieper</a></div><div class="site-subtitle font-italic">Backend software engineer</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/ricardopieper" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/ricardopieper1" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Deploying an ASP.NET gRPC service on GKE with GCE Ingress</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Deploying an ASP.NET gRPC service on GKE with GCE Ingress</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/ricardopieper">Ricardo Pieper</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" date="2021-12-11 03:00:00 -0300" data-toggle="tooltip" data-placement="bottom" title="Sat, Dec 11, 2021, 3:00 AM -0300" >Dec 11, 2021</em> </span> <span> Updated <em class="timeago" date="2023-11-07 22:58:51 -0300 " data-toggle="tooltip" data-placement="bottom" title="Tue, Nov 7, 2023, 10:58 PM -0300" >Nov 7</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1467 words"> <em>8 min</em> read</span></div></div></div><div class="post-content"><h2 id="context">Context<a href="#context"><i class="fas fa-hashtag"></i></a></h2></h2><p>At Monomyto Game Studios, we use Kubernetes to manage our infrastructure. Our backend team consists, currently, of just one person (me), so I’d like to keep things as simple as possible, while still having a way to define all of our infrastructure in a single place, and make it deployable quickly using <code class="language-plaintext highlighter-rouge">kubectl</code>. Our development team is mostly composed of Unity programmers, some of them having done a little bit of backend development but not much.</p><p>Our game, Gunstars, has a gRPC service written in C# and ASP.NET. We also use MagicOnion as an abstraction layer on top of gRPC, as it works well on Unity and makes it possible to simply define interfaces instead of writing <code class="language-plaintext highlighter-rouge">.proto</code> files. In order to manage and scale this application, we use Kubernetes. Specifically, we decided to deploy it on GKE (Google Kubernetes Engine). Our requirements for this application are:</p><ul><li>Handle realtime communications<li>Manage player sessions<li>Manage squads<li>Perform matchmaking functions<li>Manage friend requests</ul><p>As you might know, gRPC uses HTTPS/2 under the hood to establish a bidirectional communications channel. This application is exposed to the internet, and therefore needs HTTPS to make the communication secure.</p><h2 id="configuring-https--http2">Configuring HTTPS + HTTP/2<a href="#configuring-https--http2"><i class="fas fa-hashtag"></i></a></h2></h2><p>For a simple service that does not need HTTPS, we can simply use a <code class="language-plaintext highlighter-rouge">LoadBalancer</code> service on kubernetes:</p><div class="language-yml highlighter-rouge"><div class="code-header"> <span label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">gunstars-realtime-service</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">gunstars-realtime-service</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">5000</span>
      <span class="na">targetPort</span><span class="pi">:</span> <span class="m">5000</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">gunstars-realtime</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">LoadBalancer</span>
</pre></table></code></div></div><p>The load balancer will be exposed to the internet, and GKE will automatically assign a public IP to this service. However, our options are limited here in terms of HTTPS: There seems to be no way to configure the load balancer with this kind of service.</p><p>Thankfully, we have another kind of resource on kubernetes: Ingress. An external ingress also exposes a service to the internet, but we have more options to play with. Let’s take a look at our deployment first:</p><div class="language-yml highlighter-rouge"><div class="code-header"> <span label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="c1"># Some details ommited for brevity</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">gunstars-realtime</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">gunstars-realtime</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">gunstars-realtime</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">gunstars-realtime</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">gunstars-realtime</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s2">"</span><span class="s">..."</span>
        <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Always"</span>
        <span class="na">env</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ASPNETCORE_URLS</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">http://+:5000;http://+:5001"</span>
        <span class="na">ports</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">5000</span>
          <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">5001</span>
</pre></table></code></div></div><p>This deployment exposes 2 ports: 5000 and 5001. 5000 will be used for the gRPC HTTP/2 connections, while 5001 is only for health checking and will not be exposed to the internet. Notice that our ASPNETCORE_URLS also configures some HTTP listeners. This is where my mistake lives, as you’ll soon find out.</p><p>Now it’s time to define our service. Let’s take a look:</p><div class="language-yml highlighter-rouge"><div class="code-header"> <span label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="na">cloud.google.com/app-protocols</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{"grpc":"HTTP2",</span><span class="nv"> </span><span class="s">"health":"HTTP"}'</span>
    <span class="na">cloud.google.com/backend-config</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{"default":</span><span class="nv"> </span><span class="s">"gunstars-realtime-healthcheck"}'</span>
    <span class="na">cloud.google.com/neg</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{"ingress":</span><span class="nv"> </span><span class="s">true,</span><span class="nv"> </span><span class="s">"exposed_ports":</span><span class="nv"> </span><span class="s">{"5000":{}}}'</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">gunstars-realtime-service</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">gunstars-realtime-service</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">5000</span>
      <span class="na">targetPort</span><span class="pi">:</span> <span class="m">5000</span>
      <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">grpc</span>
    <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">5001</span>
      <span class="na">targetPort</span><span class="pi">:</span> <span class="m">5001</span>
      <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">health</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">gunstars-realtime</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">NodePort</span>
</pre></table></code></div></div><p>Notice that we define the ports of the service. The <code class="language-plaintext highlighter-rouge">cloud.google.com/app-protocols</code> annotation lets us define the protocol for each port, which have been named as <code class="language-plaintext highlighter-rouge">grpc</code> or <code class="language-plaintext highlighter-rouge">health</code>.</p><p>Also notice the <code class="language-plaintext highlighter-rouge">cloud.google.com/backend-config</code> annotation: we need to tell GKE how to perform health checking on our service, otherwise the backend will report its status as <code class="language-plaintext highlighter-rouge">NOT_READY</code> or <code class="language-plaintext highlighter-rouge">UNKNOWN</code>. We also explicitly tell which ports are exposed. Maybe some of this configuration isn’t really necessary, but I haven’t tested yet.</p><p>Our backend config looks like this:</p><div class="language-yml highlighter-rouge"><div class="code-header"> <span label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">cloud.google.com/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">BackendConfig</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">gunstars-realtime-healthcheck</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">healthCheck</span><span class="pi">:</span>
    <span class="na">checkIntervalSec</span><span class="pi">:</span> <span class="m">15</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">5001</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">HTTP</span>
    <span class="na">requestPath</span><span class="pi">:</span> <span class="s">/health</span>
  <span class="na">connectionDraining</span><span class="pi">:</span>
    <span class="na">drainingTimeoutSec</span><span class="pi">:</span> <span class="m">15</span>
</pre></table></code></div></div><h3 id="ingress-definition">Ingress definition<a href="#ingress-definition"><i class="fas fa-hashtag"></i></a></h3></h3><p>To define an ingress, we have a choice to make. We can use a load balancer such as Nginx, or use Google’s load balancer. Each one has its pros and cons: Nginx has tons of configurations to choose and is very flexible, while GCE Load balancer is not very configurable. However, due to the size and inexperience of the team regarding backend services, the tradeoff I’m choosing is letting GCE manage most things. The backend is a responsability of the entire company, and everyone should have some knowledge about how it works. Linking a certificate with Nginx automatically would require a ton of configuration with <code class="language-plaintext highlighter-rouge">cert-manager.io</code>, which would use Letsencrypt to generate a certificate, and renew it. However, the amount of configuration needed can be overwhelming. Therefore, we chose GCE’s load balancer (GCLB) which is the default load balancer on GKE.</p><p>Therefore, we can just declare a <code class="language-plaintext highlighter-rouge">ManagedCertificate</code> like this:</p><div class="language-yml highlighter-rouge"><div class="code-header"> <span label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.gke.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ManagedCertificate</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">gunstars-realtime-cert</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">domains</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">...(ommited)...</span>
</pre></table></code></div></div><p>This certificate can be linked to the ingress:</p><div class="language-yml highlighter-rouge"><div class="code-header"> <span label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Ingress</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">gunstars-realtime-https-ingress</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="na">networking.gke.io/managed-certificates</span><span class="pi">:</span> <span class="s2">"</span><span class="s">gunstars-realtime-cert"</span>
    <span class="na">kubernetes.io/ingress.global-static-ip-name</span><span class="pi">:</span> <span class="s">gunstars-realtime-ingress</span> <span class="c1">#a reserved IP</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">defaultBackend</span><span class="pi">:</span>
    <span class="na">service</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">gunstars-realtime-service-https</span>
      <span class="na">port</span><span class="pi">:</span>
        <span class="na">number</span><span class="pi">:</span> <span class="m">5000</span>
</pre></table></code></div></div><p>And success! Everything should work, right?</p><h3 id="incorrect-assumptions">Incorrect assumptions<a href="#incorrect-assumptions"><i class="fas fa-hashtag"></i></a></h3></h3><p>… and there goes 3 or 4 days investigating why it doesnt. Turns out that, whenever I sent a request to the backend, I would be met with a 502 error, while the access logs on the Ingress would just say <code class="language-plaintext highlighter-rouge">failed_to_connect_to_backend</code>. Why would that be the case?</p><p>I tried deploying an HTTP1.1 application, it worked fine. I tried using the <code class="language-plaintext highlighter-rouge">gcr.io/google-containers/echoserver</code> to test HTTP/2 specifically, it worked fine. What gives?</p><p>In my experience, the applications inside our network (behind a load balancer) can just listen to unencrypted traffic, while the load balancer takes care of HTTPS. It seems like this works for HTTP 1.1, but GKE is quite picky regarding HTTP/2. It is assumed that HTTP/2 will always use HTTPS, but that’s not entirely true: it is possible to use unencrypted HTTP/2 (for instance, when testing things locally).</p><p>Let’s take a look at our deployment again, specifically our environment variables:</p><div class="language-yml highlighter-rouge"><div class="code-header"> <span label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="na">env</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ASPNETCORE_URLS</span>
    <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">http://+:5000;http://+:5001"</span>
</pre></table></code></div></div><p>That seems to be following what’s been true in my experience. My ASP.NET application is listening on port 5000 unencrypted.</p><p><strong>However</strong>, for some reason, that doesn’t work: we need to use HTTPS <strong>in the deployment</strong> as well! So I changed our deployment to this:</p><div class="language-yml highlighter-rouge"><div class="code-header"> <span label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="na">env</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ASPNETCORE_URLS</span>
    <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">https://+:5000;http://+:5001"</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ASPNETCORE_Kestrel__Certificates__Default__Path</span>
    <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">./https/aspnetapp.pfx"</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ASPNETCORE_Kestrel__Certificates__Default__Password</span>
    <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">..."</span>
</pre></table></code></div></div><p>Now Kestrel is listening on 5000 for HTTPS traffic, and I just used the development certificate I already had in hand. GCLB will not check whether the certificate is valid or not.</p><p>I also defined the URLs in the <code class="language-plaintext highlighter-rouge">appsettings.json</code> file:</p><div class="language-js highlighter-rouge"><div class="code-header"> <span label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="p">{</span>
  <span class="dl">"</span><span class="s2">Kestrel</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">Endpoints</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">Grpc</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">Url</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">https://0.0.0.0:5000</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">Protocols</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Http2</span><span class="dl">"</span>
      <span class="p">},</span>
      <span class="dl">"</span><span class="s2">Http</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">Url</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">http://0.0.0.0:5001</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">Protocols</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Http1</span><span class="dl">"</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>And that works!</p><h2 id="conclusion">Conclusion<a href="#conclusion"><i class="fas fa-hashtag"></i></a></h2></h2><p>After googling for 3 days on and off for a solution to <code class="language-plaintext highlighter-rouge">failed_to_connect_to_backend</code>, I couldn’t find anything. Everything seemed to indicate that unencrypted traffic to the backend should work. However, I actually didn’t read things carefully. For instance:</p><p><a href="https://serverfault.com/questions/1013642/gcp-https-lb-health-check-is-working-but-no-real-traffic-getting-in-what-could">GCP HTTPS LB health check is working but no real traffic getting in, what could explain this?</a></p><p><a href="https://stackoverflow.com/questions/51474928/gcp-load-balancer-502-server-error-failed-to-connect-to-backend">GCP Load Balancer: 502 Server Error, “failed_to_connect_to_backend”</a></p><p>On these stackoverflow posts, it now seems to be implied that the deployment (or backend instances) should be listening for HTTPS, encrypted traffic.</p><p>Other posts are seemingly more thorough, but do not address the issue at all:</p><p><a href="https://stackoverflow.com/questions/63289794/server-behind-gcp-load-balancer-occalionally-gets-502-server-error-failed-to-c">Server behind GCP Load Balancer occalionally gets 502 Server Error, “failed_to_connect_to_backend”</a></p><p>When you do things in a rush and have to do many context switches in your day, keeping track of everything and give that much attention to detail to what people write can be hard. I think this should be better documented in the GKE guides. As someone who is responsible for the backend services but isn’t that much familiar with proxies and load balancing configuration, this can be an unnecessarily time consuming endeavor.</p><p>Maybe if I had read things more carefully I would have realized this before. But if you’re having the same problem as me (<code class="language-plaintext highlighter-rouge">failed_to_connect_to_backend</code>), there you go: <strong>just do HTTPS all the way, and use a self-signed certificate on the deployment</strong>. Another possible fix is to use nginx, which offers far more flexibility and tons of configurations, and <code class="language-plaintext highlighter-rouge">cert-manager.io</code> to automatically apply SSL certificates to the ingress, just be aware that this can be overwhelming for a small and inexperienced team.</p><p>I hope no one wastes 3 days on this. Have a good day!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/kubernetes/'>Kubernetes</a>, <a href='/categories/gke/'>GKE</a>, <a href='/categories/gce/'>GCE</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/kubernetes-gke-gce/" class="post-tag no-text-decoration" >kubernetes gke gce</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Deploying an ASP.NET gRPC service on GKE with GCE Ingress - Ricardo Pieper&url=https://ricardopieper.github.io//posts/kubernetes-gke-grcp-aspnet/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Deploying an ASP.NET gRPC service on GKE with GCE Ingress - Ricardo Pieper&u=https://ricardopieper.github.io//posts/kubernetes-gke-grcp-aspnet/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Deploying an ASP.NET gRPC service on GKE with GCE Ingress - Ricardo Pieper&url=https://ricardopieper.github.io//posts/kubernetes-gke-grcp-aspnet/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recent Update</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/kubernetes-gke-grcp-aspnet/">Deploying an ASP.NET gRPC service on GKE with GCE Ingress</a><li><a href="/posts/redis-pitfalls/">The pitfalls of Redis</a><li><a href="/posts/rinha-compiler/">How I improved my interpreter speed by 27x - A Compiler/Interpreter Competition</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/bytecode/">bytecode</a> <a class="post-tag" href="/tags/concurrent/">concurrent</a> <a class="post-tag" href="/tags/distributed/">distributed</a> <a class="post-tag" href="/tags/interpreters/">interpreters</a> <a class="post-tag" href="/tags/kubernetes-gke-gce/">kubernetes gke gce</a> <a class="post-tag" href="/tags/redis/">redis</a> <a class="post-tag" href="/tags/rust/">rust</a> <a class="post-tag" href="/tags/tree-walker/">tree walker</a> <a class="post-tag" href="/tags/virtual-machine/">virtual machine</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/redis-pitfalls/"><div class="card-body"> <em class="timeago small" date="2023-11-07 12:00:00 -0300" >Nov 7</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>The pitfalls of Redis</h3><div class="text-muted small"><p> Over many years, I’ve been using Redis for caching and as a “distributed data structure server”. I love it. As an extremely lightweight in-memory database that Just Works™️, I’ve seen developers sl...</p></div></div></a></div><div class="card"> <a href="/posts/rinha-compiler/"><div class="card-body"> <em class="timeago small" date="2023-10-17 12:00:00 -0300" >Oct 17</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>How I improved my interpreter speed by 27x - A Compiler/Interpreter Competition</h3><div class="text-muted small"><p> In September 2023, one of the most anticipated events in Brazil took place: the “Rinha de Compiladores”. This is translated roughly to “Compiler Battle”, “Compiler Bout”, or “Compiler Fight”. If yo...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <span class="btn btn-outline-primary disabled" prompt="Older"><p>-</p></span> <a href="/posts/rinha-compiler/" class="btn btn-outline-primary" prompt="Newer"><p>How I improved my interpreter speed by 27x - A Compiler/Interpreter Competition</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/ricardopieper1">Ricardo Pieper</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/bytecode/">bytecode</a> <a class="post-tag" href="/tags/concurrent/">concurrent</a> <a class="post-tag" href="/tags/distributed/">distributed</a> <a class="post-tag" href="/tags/interpreters/">interpreters</a> <a class="post-tag" href="/tags/kubernetes-gke-gce/">kubernetes gke gce</a> <a class="post-tag" href="/tags/redis/">redis</a> <a class="post-tag" href="/tags/rust/">rust</a> <a class="post-tag" href="/tags/tree-walker/">tree walker</a> <a class="post-tag" href="/tags/virtual-machine/">virtual machine</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
